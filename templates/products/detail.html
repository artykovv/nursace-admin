{% extends "base.html" %}

{% block content %}
<style>
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z'/%3e%3c/svg%3e");
    }
    .carousel-control-next-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }
    .carousel-indicators [data-bs-target] {
        background-color: #000 !important;
    }
    .carousel-indicators .active {
        background-color: #000 !important;
        opacity: 1 !important;
    }
    .carousel-item img {
        border-radius: 16px;
    }
    .Product-Info table {
        width: 100%;
        max-width: 600px;
        margin-top: 20px;
    }
    .Product-Info th, .Product-Info td {
        padding: 8px;
        text-align: left;
        vertical-align: top;
    }
    .Product-Info th {
        font-weight: bold;
        width: 30%;
    }
    .product_discount_badge {
        display: inline-block;
        min-width: 60px;
        min-height: 24px;
        visibility: hidden;
    }
    .old_price {
        min-width: 100px;
        min-height: 24px;
        visibility: hidden;
    }
    .product_discount_badge.visible {
        visibility: visible;
    }
    .old_price.visible {
        visibility: visible;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col-md-6">
            <div class="Product-Images">
                <div id="carouselProductImages" class="carousel slide">
                    <div class="carousel-indicators"></div>
                    <div class="carousel-inner"></div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselProductImages" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselProductImages" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
                <div class="mt-3 text-center">
                    <a href="/products/{{ product_id }}/image" class="btn btn-warning w-100">Изменить</a>
                </div>
            </div>
        </div>
        <div class="offset-xl-1 pt-4 col-xl-5 col-md-6">
            <div class="Product-Info">
                <table>
                    <tr><th>Название</th><td id="productName">—</td></tr>
                    <tr><th>Артикул</th><td id="productArticul">—</td></tr>
                    <tr><th>Цена</th><td><span id="newPrice"></span></td></tr>
                    <tr><th>Цена со скидкой</th><td><span id="oldPrice" class="old_price"></span></td></tr>
                    <tr><th>Скидка</th><td><span id="discountBadge" class="product_discount_badge"></span></td></tr>
                    <tr><th>Категория</th><td id="product-category">—</td></tr>
                    <tr><th>Бренд</th><td id="product-brand">—</td></tr>
                    <tr><th>Коллекция</th><td id="product-collection">—</td></tr>
                    <tr><th>Сезон</th><td id="product-season">—</td></tr>
                    <tr><th>Пол</th><td id="product-sex">—</td></tr>
                    <tr><th>Цвет</th><td id="product-color">—</td></tr>
                    <tr><th>Материал</th><td id="product-material">—</td></tr>
                    <tr><th>Размер</th><td id="product-size">—</td></tr>
                    <tr><th>Описание</th><td id="product-description">—</td></tr>
                    <tr><th>Наличие</th><td id="product-quantity">—</td></tr>
                </table>
                <div class="mt-4 text-center">
                    <a href="/products/{{ product_id }}/info" class="btn btn-warning w-100" style="display:none;">Изменить</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SiteUrl = "{{ site_url_and_port }}";
    let ProductID = "{{product_id}}";
    const PLACEHOLDER_IMAGE = "https://placehold.co/1000x1000";

    async function fetchJSON(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch ${url}`);
        return response.json();
    }
    async function safeFetchJSON(url) {
        try {
            return await fetchJSON(url);
        } catch (err) {
            return null;
        }
    }
    function setMetaTags(product) {
        if (product.fashion_name) {
            document.title = product.fashion_name;
        }
    }
    function setupCarousel(images, goodName) {
        const carouselIndicators = document.querySelector('.carousel-indicators');
        const carouselInner = document.querySelector('.carousel-inner');
        carouselIndicators.innerHTML = '';
        carouselInner.innerHTML = '';
        if (!images || !Array.isArray(images) || images.length === 0) {
            images = [{ image_url: PLACEHOLDER_IMAGE }];
        }
        images.forEach((image, index) => {
            const indicator = document.createElement('button');
            indicator.type = 'button';
            indicator.setAttribute('data-bs-target', '#carouselProductImages');
            indicator.setAttribute('data-bs-slide-to', index);
            indicator.setAttribute('aria-label', `Slide ${index + 1}`);
            if (index === 0) {
                indicator.classList.add('active');
                indicator.setAttribute('aria-current', 'true');
            }
            carouselIndicators.appendChild(indicator);
            const carouselItem = document.createElement('div');
            carouselItem.classList.add('carousel-item');
            if (index === 0) {
                carouselItem.classList.add('active');
            }
            const img = document.createElement('img');
            img.src = image.image_url || PLACEHOLDER_IMAGE;
            img.classList.add('d-block', 'w-100');
            img.alt = goodName || 'Product image';
            img.onerror = function() {
                this.src = PLACEHOLDER_IMAGE;
            };
            carouselItem.appendChild(img);
            carouselInner.appendChild(carouselItem);
        });
    }
    function renderProductDetails(product) {
        const productName = document.getElementById('productName');
        const productArticul = document.getElementById('productArticul');
        const discountBadge = document.getElementById('discountBadge');
        const oldPrice = document.getElementById('oldPrice');
        const newPrice = document.getElementById('newPrice');
        productName.textContent = product.good_name || 'Product Name';
        productArticul.textContent = product.articul || '—';
        const hasDiscount = product.retail_price !== product.retail_price_with_discount;
        const discountPercentage = hasDiscount 
            ? Math.round(((product.retail_price - product.retail_price_with_discount) / product.retail_price) * 100)
            : 0;
        if (hasDiscount) {
            discountBadge.classList.add('visible');
            discountBadge.textContent = `-${discountPercentage}%`;
            oldPrice.classList.add('visible');
            oldPrice.textContent = product.retail_price + ' сом';
            newPrice.textContent = product.retail_price_with_discount + ' сом';
        } else {
            discountBadge.classList.remove('visible');
            oldPrice.classList.remove('visible');
            newPrice.textContent = product.retail_price + ' сом';
        }
    }
    async function loadProductDetails(productId) {
        try {
            const product = await fetchJSON(`${SiteUrl}/products/${productId}`);
            setMetaTags(product);
            setupCarousel(product.images, product.good_name);
            renderProductDetails(product);
            const [category, manufacturer, collection, season, sex, color, material] = await Promise.all([
                safeFetchJSON(`${SiteUrl}/categories/${product.category_id}`),
                safeFetchJSON(`${SiteUrl}/manufacturers/${product.manufacturer_id}`),
                safeFetchJSON(`${SiteUrl}/collections/${product.collection_id}`),
                safeFetchJSON(`${SiteUrl}/seasons/${product.season_id}`),
                safeFetchJSON(`${SiteUrl}/sexes/${product.sex_id}`),
                safeFetchJSON(`${SiteUrl}/colors/${product.color_id}`),
                safeFetchJSON(`${SiteUrl}/materials/${product.material_id}`)
            ]);
            document.getElementById("product-category").textContent = category?.category_name || "—";
            document.getElementById("product-brand").textContent = manufacturer?.manufacturer_name || "—";
            document.getElementById("product-collection").textContent = collection?.collection_name || "—";
            document.getElementById("product-season").textContent = season?.season_name || "—";
            document.getElementById("product-sex").textContent = sex?.sex_name || "—";
            document.getElementById("product-color").textContent = product.color?.color_name || color?.color_name || "—";
            document.getElementById("product-material").textContent = material?.material_name || "—";
            document.getElementById("product-size").textContent = product.product_size || "—";
            document.getElementById("product-description").textContent = product.description || "—";
            document.getElementById("product-quantity").textContent = product.warehouse_quantity != null ? product.warehouse_quantity + " шт" : "—";
        } catch (err) {
            document.getElementById("productName").textContent = "Ошибка загрузки товара";
            document.getElementById("productArticul").textContent = "—";
            setupCarousel([{ image_url: PLACEHOLDER_IMAGE }], 'Placeholder image');
            renderProductDetails({
                good_name: 'Error loading product',
                retail_price: 0,
                retail_price_with_discount: 0,
                articul: '—'
            });
            document.querySelectorAll(".Product-Info table td").forEach(td => {
                td.textContent = "Ошибка";
            });
        }
    }
    document.addEventListener('DOMContentLoaded', async () => {
        await loadProductDetails(ProductID);
    });
</script>
{% endblock %} 