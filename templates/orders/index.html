{% extends 'base.html' %}
{% block content %}
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Заказы</h1>
            <a href="#" class="btn btn-primary d-flex align-items-center">
                <i class="bi bi-plus-circle me-2"></i> Добавить
            </a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th style="cursor:pointer;" id="sort-id">Заказ <span id="sort-id-icon"></span></th>
                        <th style="cursor:pointer;" id="sort-client">Клиент</th>
                        <th style="cursor:pointer;" id="sort-date">Дата <span id="sort-date-icon"></span></th>
                        <th style="cursor:pointer;" id="sort-status">Статус</th>
                        <th style="cursor:pointer;" id="sort-price">Итог <span id="sort-price-icon"></span></th>
                    </tr>
                </thead>
                <tbody id="orders-list"></tbody>
            </table>
        </div>
    </div>

<script>
const SiteUrlAndPort = window.SiteUrlAndPort || "{{ site_url_and_port }}";

let sortField = 'id';
let sortDir = 'desc';

function renderOrders(data, statusMap) {
    // сортировка
    const sorted = [...data].sort((a, b) => {
        let av, bv;
        if (sortField === 'id') {
            av = a.id; bv = b.id;
        } else if (sortField === 'date') {
            av = new Date(a.created_at); bv = new Date(b.created_at);
        } else if (sortField === 'price') {
            av = parseFloat(a.total_price); bv = parseFloat(b.total_price);
        } else {
            av = a[sortField]; bv = b[sortField];
        }
        if (av < bv) return sortDir === 'asc' ? -1 : 1;
        if (av > bv) return sortDir === 'asc' ? 1 : -1;
        return 0;
    });
    // визуальные индикаторы
    document.getElementById('sort-id-icon').textContent = sortField==='id' ? (sortDir==='asc'?'▲':'▼') : '';
    document.getElementById('sort-date-icon').textContent = sortField==='date' ? (sortDir==='asc'?'▲':'▼') : '';
    document.getElementById('sort-price-icon').textContent = sortField==='price' ? (sortDir==='asc'?'▲':'▼') : '';

    const list = document.getElementById('orders-list');
    if (!Array.isArray(sorted) || sorted.length === 0) {
        list.innerHTML = '<tr><td colspan="5"><div class="alert alert-info mb-0">Нет заказов</div></td></tr>';
        return;
    }
    list.innerHTML = sorted.map(order => {
        const statusObj = statusMap[order.status_id] || {};
        const statusText = statusObj.description || statusObj.name || order.status_id || '';
        return `
            <tr style="cursor:pointer;" onclick="window.location='/orders/${order.id}'">
                <td><b>#${order.id}</b></td>
                <td>${order.info?.first_name || ''} ${order.info?.last_name || ''}</td>
                <td>${order.created_at ? new Date(order.created_at).toLocaleString() : ''}</td>
                <td>${statusText}</td>
                <td><b>${order.total_price}</b></td>
            </tr>
        `;
    }).join('');
}

Promise.all([
    fetch(`${SiteUrlAndPort}/orders/`).then(res => res.json()),
    fetch(`${SiteUrlAndPort}/orders/statuses/`).then(res => res.json())
]).then(([orders, statuses]) => {
    const statusMap = {};
    if (Array.isArray(statuses)) {
        statuses.forEach(s => statusMap[s.id] = s);
    }
    renderOrders(orders, statusMap);
    document.getElementById('sort-id').onclick = function() {
        if (sortField === 'id') sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        else { sortField = 'id'; sortDir = 'desc'; }
        renderOrders(orders, statusMap);
    };
    document.getElementById('sort-date').onclick = function() {
        if (sortField === 'date') sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        else { sortField = 'date'; sortDir = 'desc'; }
        renderOrders(orders, statusMap);
    };
    document.getElementById('sort-price').onclick = function() {
        if (sortField === 'price') sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        else { sortField = 'price'; sortDir = 'desc'; }
        renderOrders(orders, statusMap);
    };
}).catch(() => {
    document.getElementById('orders-list').innerHTML = '<tr><td colspan="5"><div class="alert alert-danger mb-0">Ошибка загрузки заказов</div></td></tr>';
});
</script>
{% endblock %} 