{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="mb-3">
        <a href="/orders/{{ order_id }}" class="btn btn-link">&larr; К заказу</a>
    </div>
    <h2 id="order-title">Изменить заказ #{{ order_id }}</h2>
    <div id="edit-section"></div>
</div>

<script>
const SiteUrlAndPort = window.SiteUrlAndPort || "{{ site_url_and_port }}";
const orderId = "{{ order_id }}";
let statusesList = [];

function getToken() {
    const match = document.cookie.match(/(?:^|; )Bearer=([^;]*)/);
    return match ? decodeURIComponent(match[1]) : '';
}
const token = getToken();

function fetchWithAuth(url, options = {}) {
    options.headers = {
        ...(options.headers || {}),
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
        "Accept": "application/json"
    };
    return fetch(url, options);
}

function fetchJsonWithAuth(url) {
    return fetchWithAuth(url).then(res => res.json());
}

function renderEditForm(order, info, statuses) {
    document.getElementById('edit-section').innerHTML = `
        <form id="edit-order-form" class="mt-4">
            <h5>Редактировать заказ</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-2">
                        <label class="form-label">Имя</label>
                        <input type="text" class="form-control" name="first_name" value="${info.first_name || ''}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Фамилия</label>
                        <input type="text" class="form-control" name="last_name" value="${info.last_name || ''}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Адрес</label>
                        <input type="text" class="form-control" name="address_line1" value="${info.address_line1 || ''}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Город</label>
                        <input type="text" class="form-control" name="city" value="${info.city || ''}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Регион</label>
                        <input type="text" class="form-control" name="region" value="${info.region || ''}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Почтовый код</label>
                        <input type="text" class="form-control" name="postal_code" value="${info.postal_code || ''}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Телефон</label>
                        <input type="text" class="form-control" name="phone" value="${info.phone || ''}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Комментарий</label>
                        <input type="text" class="form-control" name="order_note" value="${info.order_note || ''}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-2">
                        <label class="form-label">Статус</label>
                        <select class="form-select" name="status_id">
                            ${statuses.map(s => `<option value="${s.id}" ${order.status_id==s.id?'selected':''}>${s.description || s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Сумма</label>
                        <input type="number" class="form-control" name="total_price" value="${order.total_price}">
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-success mt-3">Сохранить</button>
            <a href="/orders/${order.id}" class="btn btn-secondary mt-3 ms-2">Отмена</a>
        </form>
    `;
    document.getElementById('edit-section').style.display = '';
    document.getElementById('edit-order-form').onsubmit = function(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const infoPayload = {
            user_id: order.user_id,
            first_name: fd.get('first_name'),
            last_name: fd.get('last_name'),
            address_line1: fd.get('address_line1'),
            city: fd.get('city'),
            region: fd.get('region'),
            postal_code: fd.get('postal_code'),
            phone: fd.get('phone'),
            order_note: fd.get('order_note')
        };
        fetchWithAuth(`${SiteUrlAndPort}/orders/info/${order.info_id}`, {
            method: 'PUT',
            body: JSON.stringify(infoPayload)
        })
        .then(res => res.json())
        .then(() => {
            const orderPayload = {
                user_id: order.user_id,
                session_id: order.session_id,
                total_price: Number(fd.get('total_price')),
                status_id: Number(fd.get('status_id')),
                info_id: order.info_id
            };
            return fetchWithAuth(`${SiteUrlAndPort}/orders/${orderId}`, {
                method: 'PUT',
                body: JSON.stringify(orderPayload)
            });
        })
        .then(() => { window.location = `/orders/${order.id}`; })
        .catch(() => { alert('Ошибка при сохранении'); });
    };
}

Promise.all([
    fetchJsonWithAuth(`${SiteUrlAndPort}/orders/${orderId}`),
    fetchJsonWithAuth(`${SiteUrlAndPort}/orders/statuses/`)
]).then(([order, statuses]) => {
    if (!order || !order.id) {
        document.getElementById('edit-section').innerHTML = '<div class="alert alert-danger">Заказ не найден</div>';
        return;
    }
    statusesList = statuses;
    renderEditForm(order, order.info || {}, statusesList);
}).catch(() => {
    document.getElementById('edit-section').innerHTML = '<div class="alert alert-danger">Ошибка загрузки заказа</div>';
});
</script>
{% endblock %}
