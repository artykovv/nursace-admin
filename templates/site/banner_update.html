{% extends 'base.html' %}
{% block content %}
{% include 'components/mini_header.html' %}
<div class="container mt-4">
    <h1>Изменить баннер (карусель)</h1>
    <div id="carousel-image-section"></div>
    <div class="mt-4 text-end">
        <button id="save-carousel-images" class="btn btn-success">Сохранить</button>
    </div>
</div>
<style>
    .carousel-image-list { display: flex; flex-wrap: wrap; gap: 16px; }
    .carousel-image-card {
        border: 2px solid #eee;
        border-radius: 8px;
        padding: 8px;
        width: 160px;
        text-align: center;
        position: relative;
        background: #fafafa;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        cursor: grab;
    }
    .carousel-image-card img {
        max-width: 100%;
        max-height: 120px;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    .carousel-image-card .remove-btn {
        position: absolute;
        top: 4px; right: 4px;
        background: #dc3545;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 24px; height: 24px;
        font-size: 16px;
        cursor: pointer;
    }
    .add-carousel-image-btn {
        margin-top: 16px;
    }
</style>
<script>
const SiteUrl = "{{ site_url_and_port }}";
const carouselApiUrl = `${SiteUrl}/carousel/`;
const PLACEHOLDER_IMAGE = "https://placehold.co/160x120";
let carouselImages = [];
let newCarouselImages = [];

function getToken() {
    const match = document.cookie.match(/(?:^|; )Bearer=([^;]*)/);
    return match ? decodeURIComponent(match[1]) : '';
}
const token = getToken();

function fetchWithAuth(url, options = {}) {
    options.headers = {
        ...(options.headers || {}),
        "Authorization": `Bearer ${token}`,
        ...((options.body instanceof FormData) ? {} : {"Content-Type": "application/json"}),
        "Accept": "application/json"
    };
    return fetch(url, options);
}

async function fetchCarouselImages() {
    const res = await fetchWithAuth(carouselApiUrl);
    if (!res.ok) throw new Error('Ошибка загрузки карусели');
    return await res.json();
}

function renderCarouselImages() {
    const allImages = [...carouselImages, ...newCarouselImages];
    let html = `<div class="carousel-image-list" id="carousel-image-list">`;
    allImages.forEach((img, idx) => {
        html += `<div class="carousel-image-card" draggable="true" data-idx="${idx}">
            <img src="${img.src || PLACEHOLDER_IMAGE}" alt="image">
            <button class="remove-btn" title="Удалить" type="button">&times;</button>
        </div>`;
    });
    html += `<div class="carousel-image-card add-carousel-image-btn" style="border-style:dashed;cursor:pointer;" id="add-carousel-image-btn">
        <div style="font-size:32px;">+</div>
        <div style="font-size:14px;">Добавить</div>
        <input type="file" accept="image/*" style="display:none;" id="carousel-file-input">
    </div>`;
    html += `</div>`;
    document.getElementById('carousel-image-section').innerHTML = html;
    addCarouselImageEventListeners();
    enableCarouselDragAndDrop();
}

function addCarouselImageEventListeners() {
    // Удаление
    document.querySelectorAll('.remove-btn').forEach((btn, idx) => {
        btn.onclick = async (e) => {
            e.stopPropagation();
            const all = [...carouselImages, ...newCarouselImages];
            const img = all[idx];
            if (img.is_new) {
                newCarouselImages = newCarouselImages.filter(n => n !== img);
                renderCarouselImages();
            } else {
                // Удаляем с сервера
                if (!confirm('Удалить изображение?')) return;
                try {
                    const res = await fetchWithAuth(`${carouselApiUrl}${img.id}`, {
                        method: 'DELETE'
                    });
                    if (res.ok) {
                        carouselImages = carouselImages.filter(i => i !== img);
                        renderCarouselImages();
                    } else {
                        alert('Ошибка при удалении');
                    }
                } catch {
                    alert('Ошибка при удалении');
                }
            }
        };
    });
    // Добавить
    const addBtn = document.getElementById('add-carousel-image-btn');
    const fileInput = document.getElementById('carousel-file-input');
    addBtn.onclick = () => fileInput.click();
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('files', file);
        try {
            // Загрузка файла на сервер (можно заменить на свой endpoint)
            const uploadRes = await fetchWithAuth(`${SiteUrl}/storage/upload`, { method: 'POST', body: formData });
            const data = await uploadRes.json();
            if (data.uploaded_urls && data.uploaded_urls.length > 0) {
                newCarouselImages.push({ src: data.uploaded_urls[0], href: '', is_new: true });
                renderCarouselImages();
            } else {
                alert('Ошибка загрузки файла');
            }
        } catch {
            alert('Ошибка загрузки файла');
        }
        fileInput.value = '';
    };
}

function enableCarouselDragAndDrop() {
    const list = document.getElementById('carousel-image-list');
    let dragIdx = null;
    list.querySelectorAll('.carousel-image-card').forEach((card, idx) => {
        card.ondragstart = (e) => {
            dragIdx = idx;
            e.dataTransfer.effectAllowed = 'move';
        };
        card.ondragover = (e) => {
            e.preventDefault();
            card.style.borderColor = '#007bff';
        };
        card.ondragleave = () => {
            card.style.borderColor = '';
        };
        card.ondrop = (e) => {
            e.preventDefault();
            card.style.borderColor = '';
            if (dragIdx === null || dragIdx === idx) return;
            const all = [...carouselImages, ...newCarouselImages];
            const [moved] = all.splice(dragIdx, 1);
            all.splice(idx, 0, moved);
            carouselImages = all.filter(i => !i.is_new);
            newCarouselImages = all.filter(i => i.is_new);
            renderCarouselImages();
        };
        card.ondragend = () => {
            dragIdx = null;
            card.style.borderColor = '';
        };
    });
}

async function saveCarouselImages() {
    const all = [...carouselImages, ...newCarouselImages];
    if (all.length === 0) {
        alert('Добавьте хотя бы одно изображение');
        return;
    }
    // Сохраняем новые изображения
    for (const img of newCarouselImages) {
        try {
            const res = await fetchWithAuth(carouselApiUrl, {
                method: 'POST',
                body: JSON.stringify({ src: img.src, href: img.href })
            });
            if (!res.ok) throw new Error();
        } catch {
            alert('Ошибка при добавлении изображения');
        }
    }
    // TODO: если нужен порядок, можно реализовать PUT/PATCH
    window.location.reload();
}

document.getElementById('save-carousel-images').onclick = saveCarouselImages;

fetchCarouselImages().then(list => {
    carouselImages = list;
    newCarouselImages = [];
    renderCarouselImages();
}).catch(() => {
    carouselImages = [];
    newCarouselImages = [];
    renderCarouselImages();
});
</script>
{% endblock %} 